---
import * as fs from 'fs';
import * as path from 'path';
import type { Match, Metadata, Config } from '../types/index.js';
import Header from '../components/Header.astro';
import FilterBar from '../components/FilterBar.astro';
import MatchTable from '../components/MatchTable.astro';
import MatchCard from '../components/MatchCard.astro';

// Load config for team colors
const configPath = path.join(process.cwd(), 'config.json');
let teamColors: Map<string, string> = new Map();

if (fs.existsSync(configPath)) {
  try {
    const config: Config = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
    config.teams.forEach(team => {
      teamColors.set(team.name, team.color);
    });
  } catch (e) {
    console.error('Error reading config.json:', e);
  }
}

// Helper function to get team color
const getTeamColor = (teamName?: string): string => {
  const fallback = '#009B3E';
  if (!teamName) return fallback;
  return teamColors.get(teamName) || fallback;
};

// Load match data from JSON
const dataPath = path.join(process.cwd(), 'data', 'terminliste.json');

let matches: Match[] = [];
let metadata: Metadata | null = null;

// Load metadata
const metadataPath = path.join(process.cwd(), 'data', 'metadata.json');
if (fs.existsSync(metadataPath)) {
  try {
    metadata = JSON.parse(fs.readFileSync(metadataPath, 'utf-8'));
  } catch (e) {
    console.error('Error reading metadata.json:', e);
  }
}

// Load matches
if (fs.existsSync(dataPath)) {
  try {
    matches = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
  } catch (e) {
    console.error('Error reading terminliste.json:', e);
  }
}

// Check if we have multiple teams
const hasMultipleTeams = metadata !== null && metadata.teamsCount > 1;

const buildMatchDate = (match?: Match): Date | null => {
  if (!match) return null;
  const [day, month, year] = (match.Dato || '').split('.');
  if (!day || !month || !year) return null;
  const [hour, minute] = (match.Tid || '00:00').split(':');
  const date = new Date(
    Number(year),
    Number(month) - 1,
    Number(day),
    Number(hour) || 0,
    Number(minute) || 0
  );
  return isNaN(date.getTime()) ? null : date;
};

const normalizeMatchId = (value?: string | number | null): string => String(value ?? '').trim();

const now = new Date();
const nextMatch = matches.find((match) => {
  const date = buildMatchDate(match);
  return date && date >= now;
}) || matches[0];
const nextMatchId = normalizeMatchId(nextMatch?.Kampnr);

const formattedLastUpdated = metadata?.lastUpdated
  ? new Date(metadata.lastUpdated).toLocaleString('no-NO', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    })
  : null;

const teamNames = Array.from(teamColors.keys());
---

<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#009B3E">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/fjellhammer-logo.svg">
  <title>Terminliste - Fjellhammer G2010</title>
  <style is:global>
    :root {
      --accent: #009B3E;
      --accent-light: #00C46A;
      --accent-dark: #00652B;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: radial-gradient(circle at top, #031a10 0%, #020b05 60%, #010503 100%);
      min-height: 100vh;
      padding: 2.5rem 1rem;
      color: #f6fff8;
    }

    main {
      max-width: 1400px;
      margin: 0 auto;
      background: transparent;
      border-radius: 1rem;
      padding: 2rem;
    }

    a {
      color: var(--accent-light);
      text-decoration: none;
      transition: all 0.2s;
      position: relative;
    }

    a:hover {
      color: white;
      text-shadow: 0 0 10px rgba(0, 196, 106, 0.5);
    }

    p {
      text-align: center;
      color: #9ca3af;
      padding: 2rem;
      font-size: 1.1rem;
    }

    .last-updated {
      text-align: center;
      color: #a7c0b3;
      font-size: 0.95rem;
      margin-top: 1.75rem;
    }

    .card-container {
      display: none;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem 0.75rem;
      }

      main {
        padding: 1rem;
        background: transparent;
        box-shadow: none;
      }

      .card-container {
        display: block;
        padding: 0;
      }

      .last-updated {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
        padding: 1rem;
        background: rgba(0, 155, 62, 0.05);
        border-radius: 0.75rem;
        border: 1px solid rgba(0, 155, 62, 0.15);
      }
    }
  </style>
</head>
<body>
  <main>
    <Header />
    <FilterBar teamNames={teamNames} />

    {matches.length > 0 ? (
      <>
        <MatchTable
          matches={matches}
          hasMultipleTeams={hasMultipleTeams}
          getTeamColor={getTeamColor}
        />

        <div class="card-container">
          {matches.map((match) => (
            <MatchCard
              match={match}
              isNextMatch={nextMatchId === String(match.Kampnr || '').trim()}
              hasMultipleTeams={hasMultipleTeams}
              getTeamColor={getTeamColor}
            />
          ))}
        </div>

        {formattedLastUpdated && (
          <div class="last-updated">
            Sist oppdatert: {formattedLastUpdated}
            {hasMultipleTeams && ` • ${metadata?.teamsCount ?? matches.length} lag • ${metadata?.matchesCount ?? matches.length} kamper`}
          </div>
        )}
      </>
    ) : (
      <p>Ingen kamper funnet. Kjør data-henting først.</p>
    )}
  </main>
  <script is:inline>
    function scrollToNextMatch() {
      const nextCard = document.getElementById('next-match-card');
      if (!nextCard) return;
      const header = document.querySelector('.page-header');
      const headerHeight = header && header instanceof HTMLElement ? header.offsetHeight : 0;
      const offset = headerHeight + 16;
      const cardTop = nextCard.getBoundingClientRect().top + window.scrollY;
      window.scrollTo({
        top: Math.max(cardTop - offset, 0),
        behavior: 'smooth',
      });
    }

    // Filter state
    const filters = {
      team: 'all',
      location: 'all',
      status: 'all'
    };

    // Load saved filters from localStorage
    function loadFilters() {
      try {
        const saved = localStorage.getItem('terminliste-filters');
        if (saved) {
          Object.assign(filters, JSON.parse(saved));
        }
      } catch (e) {}
    }

    // Save filters to localStorage
    function saveFilters() {
      try {
        localStorage.setItem('terminliste-filters', JSON.stringify(filters));
      } catch (e) {}
    }

    // Apply filters to all matches
    function applyFilters() {
      const rows = document.querySelectorAll('tbody tr[data-team]');
      const cards = document.querySelectorAll('.match-card[data-team]');

      const elements = [...rows, ...cards];

      elements.forEach(el => {
        const team = el.getAttribute('data-team');
        const location = el.getAttribute('data-location');
        const status = el.getAttribute('data-status');

        const teamMatch = filters.team === 'all' || filters.team === team;
        const locationMatch = filters.location === 'all' || filters.location === location;
        const statusMatch = filters.status === 'all' || filters.status === status;

        if (teamMatch && locationMatch && statusMatch) {
          el.classList.remove('filtered-out');
        } else {
          el.classList.add('filtered-out');
        }
      });
    }

    // Update button active states and aria-pressed
    function updateButtonStates() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        const filterType = btn.getAttribute('data-filter');
        const value = btn.getAttribute('data-value');
        const isActive = filters[filterType] === value;

        if (isActive) {
          btn.classList.add('active');
          btn.setAttribute('aria-pressed', 'true');
        } else {
          btn.classList.remove('active');
          btn.setAttribute('aria-pressed', 'false');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Load saved filters
      loadFilters();
      updateButtonStates();
      applyFilters();

      // Filter button click handlers
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const filterType = btn.getAttribute('data-filter');
          const value = btn.getAttribute('data-value');

          filters[filterType] = value;
          saveFilters();
          updateButtonStates();
          applyFilters();
        });
      });

      // Auto-scroll on page load for mobile
      const prefersCards = window.matchMedia('(max-width: 768px)').matches;
      if (prefersCards) {
        setTimeout(() => {
          scrollToNextMatch();
        }, 100);
      }

      // Add click handler to button
      const scrollBtn = document.getElementById('scroll-to-next');
      if (scrollBtn) {
        scrollBtn.addEventListener('click', scrollToNextMatch);
      }

      // Register service worker for PWA
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      }
    });
  </script>
</body>
</html>
